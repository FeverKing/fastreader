name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: Build all platforms
      run: make all
      
    - name: Create release packages
      run: make release
      
    - name: List build artifacts
      run: ls -la dist/
      
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: FastReader ${{ steps.get_version.outputs.VERSION }}
        body: |
          ## FastReader ${{ steps.get_version.outputs.VERSION }}
          
          ### Downloads
          
          Choose the appropriate binary for your platform:
          
          - **Linux**: `fastreader-linux-amd64.tar.gz`, `fastreader-linux-386.tar.gz`, `fastreader-linux-arm64.tar.gz`, `fastreader-linux-arm.tar.gz`
          - **Windows**: `fastreader-windows-amd64.zip`, `fastreader-windows-386.zip`
          - **macOS**: `fastreader-darwin-amd64.tar.gz`, `fastreader-darwin-arm64.tar.gz`
          - **FreeBSD**: `fastreader-freebsd-amd64.tar.gz`
          
          ### Usage
          
          ```bash
          # Generate index
          ./fastreader data.csv gen
          
          # Get line count
          ./fastreader data.csv cnt
          
          # Read specific lines
          ./fastreader data.csv 1:100
          
          # Use verbose mode for detailed information
          ./fastreader -v data.csv gen
          ```
          
          ### Features
          
          - ğŸš€ Fast file reader for large files
          - ğŸ”§ Multi-threaded processing with configurable workers
          - ğŸ’¾ Memory management with configurable limits
          - ğŸ” Flexible command-line interface with parameter shortcuts
          - ğŸ“Š IO statistics with verbose mode
          - âš¡ Read-ahead buffer optimization
          - ğŸ¯ Support for negative indexing (Python-like)
          
          ### Options
          
          - `-m, --max-mem <value>`: Maximum memory usage in GB
          - `-i, --index-indent <value>`: Index interval in lines
          - `-w, --workers <value>`: Number of concurrent workers
          - `-v, --verbose`: Show verbose information
          - `-h, --help`: Show help information
        files: |
          dist/*.tar.gz
          dist/*.zip
        draft: false
        prerelease: false
        generate_release_notes: true
